#!/usr/bin/python3
#
# Copyright (C) 2017  FreeIPA Contributors see COPYING for license
#

import os
import syslog
import traceback

from ipaplatform.constants import constants
from ipaplatform.paths import paths
from ipaplatform import services
from ipaserver.install import certs


def main():
    root = 0  # root
    krb5kdc_gid = constants.KRB5KDC_GROUP.gid
    os.chown(paths.KDC_KEY, root, krb5kdc_gid)
    os.chown(paths.KDC_CERT, root, krb5kdc_gid)

    with certs.renewal_lock:
        try:
            if services.knownservices.krb5kdc.is_running():
                syslog.syslog(syslog.LOG_NOTICE, 'restarting krb5kdc')
                services.knownservices.krb5kdc.restart()
        except Exception as e:
            syslog.syslog(
                syslog.LOG_ERR, "cannot restart krb5kdc: {}".format(e))


try:
    main()
except Exception:
    syslog.syslog(syslog.LOG_ERR, traceback.format_exc())
